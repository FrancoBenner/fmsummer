\chapter{Portfolio Optimization, Transaction Costs \& Dynamic Games 1 - Muhle-Karbe}
\begin{enumerate}
	\item Setting
	\item Frictionless Control Heuristics (no transaction costs)
	\item Verification via Convex Duality
	\item Control Heuristics with Transaction Costs
	\item Verification via Shadow Prices
\end{enumerate}

We'll consider the Black-Merton-Scholes model with two assets:
\begin{enumerate}
	\item Safe asset normalized to $S^0_t=1$
	\item Risky asset following geometric Brownian Motion:
	\begin{equation}
		\frac{dS_t}{S_t} = \mu dt + \sigma dW_t
	\end{equation}
	for a standard Brownian motion $(W_t)_{t\geq 0}$ defined on a filtered probability space $(\Omega, \mathcal{F}, (\mathcal{F}_t)_{t\geq 0}, P)$.
	\item Returns have constant expectations $\mu > 0$, vol $\sigma >0$
	\item simplest benchmark
	\item no tx costs
\end{enumerate}

We start with a positive cash endowment $x > 0$. An investor c hooses number $\varphi_t$ of risky shares. Corresponding wealth process:
\begin{equation}
	X_t^{\varphi} = x + \int_0^t \varphi_s dS_s
\end{equation}
The safe position implicitly determined by self-financing condition:
\begin{equation}
	\varphi_t^0 = x + \int_0^t \varphi_s dS_s - \varphi_t S_t
\end{equation}
To make everything well-defined, $(\varphi_t)_{t\geq 0}$ needs to be $S$-integrable:
\begin{equation}
	\int_0^t \varphi_s^s ds < \infty \qquad \forall t \geq 0
\end{equation}

Preferences: Investor maximize expected utility from terminal wealth at some time horizon $T>0$:
\begin{equation}
	\mathbb{E}\left[ U(X^\varphi_T) \right] \to \text{max}
\end{equation}
over all trading strategies $\varphi_t$.

The utility function $U$ should:
\begin{enumerate}
	\item be increasing: more is better than less.
	\item Concave: risky payoff is worth than its expectation
	\item Inada conditions: Extra dollar matters a lot when poor, irrelevant when rich. (Codify in math by:
	\begin{align}
		\lim_{x\to \infty} U'(x) \to 0\\
		\lim_{x\to 0} U'(x) \to \infty
	\end{align})
\end{enumerate}

One messiness here is this: The units are goofy. An alternative is to use a different unit.
A better interpretation is: maximize certainty equivalent:
\begin{equation}
	CE(\varphi) = U^{-1}(\mathbb{E}\left[ U(X_T^\varphi) \right]) \to \text{max}
\end{equation}

How can we determine optimal strategy and utility? There's a complex dependence on market parameters, investment horizon, and preferences! How can we tackle an infinite dimensional stochastic control problem? Today, we'll do a heuristic derivation and tomorrow, we'll do a rigorous verification.

We first make the problem harder: via a value function like
\begin{equation}
	v(t,x) := \sup_{(\varphi_s)_{s\in[t,T]}} \mathbb{E}\left[ U(x + \int_t^T \varphi_s dS_s) | \mathcal{F}_t\right]
\end{equation}, which evaluates along any wealth process $X_t^\varphi$ (a supermartingale with nonpositive drift) and along optimal wealth $X_t^{\hat{\varphi}}$(martingale with zero drift.) This boils down to: ``Martingale optimality principle of stochastic control.'' 

What do we mean by all of this? We start with
\begin{align}
	\mathbb{E}& \left[ v(t,X_t^\varphi) | \mathcal{F}_s \right] \\
	 =& \mathbb{E} \left[ \mathbb{E}\left[ U(X^\varphi_t + \int_t^T \hat{\varphi}_s dS_s) | \mathcal{F}_t\right] | \mathcal{F}_s \right] \\
	=& \mathbb{E} \left[ U(X^\varphi_t + \int_t^T \hat{\varphi}_s dS_s) | \mathcal{F}_s \right] \\
	=& \mathbb{E} \left[ U(X^\varphi_s + \int_s^t \hat{\varphi}_s dS_s)+ \int_t^T \hat{\varphi}_s dS_s) | \mathcal{F}_s \right] \\
	\leq& \mathbb{E} \left[ U(X^\varphi_s + \int_s^T \hat{\varphi}_s dS_s) | \mathcal{F}_s \right] \\
	=& v(s,x_s^\varphi)
\end{align}

How can we use the martingale optimality princeiple? The value function $v(t,x)$ generally can depend on many state variables. Here, the wealth dynamics
\begin{align}
	d X_t^\varphi = \mu \varphi_t S_t dt + \sigma \varphi_t S_t dW_t\\
			=& \mu \eta_t dt + \sigma \eta_t dW_t
\end{align}
for some risky position $\eta_t$ only depend on the control $\eta_t$. One guess is a value function only depends on the initial wealth $x$ and time $t$. This is an assumption!! Not a result. This needs to be verified eventually.

Suppose that the value function is smooth. Then Ito's formula yields
\begin{equation}
	dv(t, X^\eta_t) = (v_t + \mu \eta_t v_x + \frac{\sigma^2}{2}\eta^2_t v_{xx})dt + (...) dW_t
\end{equation}
This should be a supermartingale for any $\eta_t$: drift $\leq 0$. It will also be a martingale for the optimizer $\hat{\eta}_t$: with drift = 0. Then maximize drift pointwise in $\eta_t$. Plug in maximizer. Set to zero. This yields equations for optimal stategry and value functions.

% missed some stuff here...

We can consider a special case: Take the exponential utility function $U(x) = -e^{-ax}$, and factor the wealth out via $v(t,x) = e^{-ax}v(t,0)$, with the constant absolute risk-tolerance $1/a$. This gives the constant risky position
\begin{equation}
	\hat{\eta}_t = \frac{\mu}{a \sigma^2}
\end{equation}
This is independent of horizon. It is independent of wealth. The value function and certainty-equivalent are the same.
\begin{equation}
	v(t,x) = -e^{-ax} \exp(\frac{\mu^2}{2\sigma^2(t-T)}) \implies CE(\hat{\varphi}) = x + \frac{\mu^2}{2 a \sigma^2} T
\end{equation}
Here, the assets are ranked by the Sharpe ratio $\mu/\sigma$. The same Sharpe ratio leads to the same payoffs.


An alternative: If we have twice as much money, we are willing to take twice as much risk. This is debatable, but why not??

\begin{equation}
	U(x) = \frac{x^{1-\gamma}}{1-\gamma} 
\end{equation}
rederive v(t,x), risk tolerance, proportion, value function, certainty equivalent.
\begin{equation}
	v(t,x) = x^{1-\gamma} v(t,1)
\end{equation}
Constant relative risk-tolerance $x/\gamma$.
Constant risky proportion $\hat{\pi}_t := \hat{\eta}_t / X^{\hat{\eta}}_{t} = \mu / \gamma \sigma^2$, which is independent of horizon.
Investment scales with wealth.

Value function and certainty equivalent:

\chapter{Lecture 2}
We can verify that all of this actually works.

\section{Verification via Convex Duality}
Need to rule out doubling strategies.
Usual notion: $X^\varphi_t \geq -C$ (we have a bounded credit line).
The value $C=0$ works well for utilities defined on $\mathbb{R}_+$; optimal wealth process for power utility follows geometric Brownian motion:
\begin{equation}
	\frac{dX_t^{\hat{\pi}}}{X_t^{\hat{\pi}}} = \frac{\mu}{\gamma \sigma^2} (\mu dt + \sigma dW_t)
\end{equation}
This is not compatible with utilities on $\mathbb{R}$: optimal wealth processes for exponential utility follows brownian motion with drift:
\begin{equation}
	dX_t^{\hat{\eta}} = \frac{\mu}{\alpha \sigma^2} (\mu dt + \sigma dW_t)
\end{equation}

How can we verify?

\subsection{Convex Duality}
For a concave function $U$, we can define the conjugate:
\begin{equation}
	V(y) = \sup_{x > 0} \{ U(x) - xy \}
\end{equation}
Then
\begin{equation}
	\mathbb{E}\left[ U(X^\varphi_T) \right] \leq 
	\mathbb{E}\left[ V(yY_T) \right] + \mathbb{E}\left[ X_TY_T \right]
	= \mathbb{E}\left[ V(yY_T) \right] + \mathbb{E}_Q\left[ X_T^\varphi \right]y
\end{equation}
for $y>0$ and density process $Y_t$ of an EMM $\mathbb{Q}$.

Then $X_t^\varphi = x + \int_0^t \varphi_s dS_s$ is a local Q-martingale.
\begin{enumerate}
	\item Supermartingale if bounded from below for utilities on $\mathbb{R}_+$
	\item Martingale if risky position is sufficiently integrable for utilities on $\mathbb{R}$ (eg, bounded). This implies admissibility.
\end{enumerate}

In either case, $\mathbb{E}[U(X_T^\varphi)] \leq \mathbb{E}[V(yY_T)] + xy$.

This upper bound is for any trading strategy $\varphi$, any $t$, and any $y$. Candidate is optimal if bound is tight for
\begin{enumerate}
	\item $U'(X_t^\varphi) = yY_t$
	\item $\mathbb{E}[ Y_T (U')^{-1}(yY_T) ] = x$
\end{enumerate}

For exponential utilities $U(x) = -e^{-\alpha x}$, we get $V(y) = \frac{y}{\alpha} \log \frac{y}{\alpha} - 1$. The second condition gives $y = \alpha \exp (-\alpha x - \mathbb{E}[ Y_T \log Y_T ])$. This yields a simplified upper bound:
\begin{equation}
	\mathbb{E} [ -e^{-\alpha X_T^\varphi}] \leq -e^{-\alpha x - \mathbb{E} [ Y_t \log Y_T ]}
\end{equation}

In complete market with unique $Y_T$, we can verify equality for candidate by direct computation! Sweet!


We can do analogous results for power utilities $U(x) = x^{1-\gamma}/ (1-\gamma)$. The conjugate comes out to $V(y) = \frac{\gamma}{1-\gamma} y^{1-1/\gamma}$. Then we look at the expectation, and look at the upper duality bound simplifies.


\section{Markets with Transaction Costs}
Before, we bought and sold at the same price $S_t$. Now, we will buy at the ask price $S_t$ and sell at the bid price $(1-\epsilon)S_t$. (clearly, $\epsilon$ is the width of the relative bid-ask spread.)  We only consider finite variation strategies $\varphi_t = \varphi_t^u - \varphi_t^d$. These track the number of shares bought and sold by time $t$, respectively. Infinite costs otherwise.

We can do integration by parts on the frictionless self-financing condition, which then reads as
\begin{equation}
	d\varphi_t^0 = \varphi_t dS_t - d(\varphi_tS_t) = -S_td\varphi_t
\end{equation}
The counterpart with transaction costs is
\begin{equation}
	d\varphi_t^0  = -S_td\varphi_t^u + (1-\epsilon)S_t d\varphi_t^d.
\end{equation}

Why is all of this important? Non-trivial spreads are common even in the most liquid markets. Constant position/weight requires infinite turnover, which causes infinite costs, which is not feasible. How can we adapt optimal trading strategies? How much welfare is lost? What are the endogenous spreads in equilibrium between market makers and rebalancing investors? (This is a sort of static game which can determine the bid-ask spread as an output of a model such as: Find a bid-ask spread by examining market maker profit from optimal strategy of traders given a bid-ask spread.) There is also a new difficulty: complex horizon dependence. Do not trade if horizon is close. Way out?

Two alternatives:
\begin{enumerate}
	\item We could look at the expected utility of the final value of our portfolio:
	\begin{equation}
		\mathbb{E}[U(X_T)]
	\end{equation}
	but this is a bit fishy...
	
	\item Another option is to look at
	\begin{equation}
		\mathbb{E}[ \int_0^\infty e^{-\beta t} U(c_t)dt ] 
	\end{equation}
	which is good, except that it is basically intractable.
\end{enumerate}

So, as before, we'll consider the exponential utility $U(x) = -e^{-\alpha x}$ or power utility $U(x) = \frac{x^{1-\gamma}}{1-\gamma}$. 
But infinite horion to reduce stationary problem:
	For exponential utilities, we maximize the equivalent annuity:
	\begin{equation}
		\limsup_{T\to \infty} - \frac{1}{\alpha T} \log \mathbb{E}\left[e^{-\alpha X_T^\varphi} \right] \to \max!
	\end{equation}
	
	For power utilities, we maximize the equivalent safe rate:
	\begin{equation}
		\limsup_{T\to \infty} \frac{1}{(1-\gamma) T} \log \mathbb{E}\left[ (X^\varphi_T)^{1-\gamma} \right] \to \max!
	\end{equation}

This keeps scaling properties in the wealth, and also gets rid of the horizon dependence.

Open questions: What are the control heuristics? How can we verify it?




